#实景路况视频存取系统
基础环境要求：Linux、本地运行IPFS节点、NODEJS、Mysql、Redis
内网访问，暂不需要加密验证。
## 功能说明
1. 文件上传API，实时返回fileID。系统记录fileName、folder、zipName等数据。
2. 计算文件夹大小，阈值为5G。可在配置文件中修改。
3. 打压缩包并加密，上传IPFS。系统记录cid、size等信息。
4. 定时任务 在crust下单，根据返回值更新数据状态，并删除本地存储的压缩包和文件目录。
5. 文件下载，申请文件下载，传fileID和cbUrl。
6. 定时任务 从ipfs下载压缩包，更新数据状态。
7. 定时任务 解密并解压缩包，获取指定文件，回调cbUrl 返回文件对应的外网下载链接。
8. 定时任务 删除已下载的压缩包。
9. 后台系统可以测试上传，查看文件和压缩包列表。
10. 持续优化更新中

### 视频文件上传接口说明文档
#### 1、存储单条视频
> 请求地址
>
> http://localhost:7001/api/open/upload
>
> 请求方式
> POST
> 请求类型
> Form表单

body参数说明

| 参数        | 是否必须      | 说明                                                                      |
| -----------|:-------:| ------:|
| file       | 是            | 文件二进制流|
| filename  | 是            | 文件名|
返回参数说明
`{ code:0, result: { fileID: 123123123 }}`

| 参数                      | 说明                   |
| --------------------------|:---------------------:|
| status               |  结果状态   |
| result                 |  结果详情|

###业务流程
1.业务方从本地数据库获取相关输入信息，并按API要求组合数据。发送给视频导入服务，服务端对传入参数进行校验成功后，将需要进行导入的视频信息保存在本地业务数据库。此阶段服务完成。视频记录的状态标记为“未打包”

2.实时判断目录的总大小达到一定的数量后（比如5G），停止往该目录存放文件并新建存放目录。对该旧目录进行加密打包。将压缩相关信息更新至每条视频的对应记录中，并在数据库中创建压缩包记录，以便后续查询和下载。压缩包名称和每条视频都要对应起来。每完成一个目录的压缩工作，立即调用IPFS的节点API，将压缩包放入IPFS网络，获取到对应的对象ID。并将这个对象ID保存到本地业务数据库中。状态标记为“已进入IPFS”。

3.定时任务，调用CRUST网络的下单接口，对已经进入“IPFS”并未续费的对象ID，进行下单操作。并记录下有效期，后期可以定期刷新有效期。同时对已经过期的对象ID也进行下单操作，刷新订单。

5.定时启动任务，扫描业务数据库，将完成下单的数据通过crust接口检查块高和副本数。换算记录对应的过期时间，判断副本数大于50则删除本地副本。



### 视频文件获取接口说明文档
#### 1、申请获取视频文件
> 请求地址
>
> http://localhost:7001/api/open/downFile
>
> 请求方式
> POST
>
body参数说明

| 参数        | 是否必须      | 说明                                                                      |
| -----------|:-------:| ------:|
| fileID       | 是            | 视频编号|
| cbUrl       | 是    |回调地址|
返回参数说明
`{status:0, result:"ok"}`

| 参数                      | 说明                   |
| --------------------------|:---------------------:|
| status               |  结果状态   |
| result                 |  结果详情|

#### 1、回调预设地址
>
> 请求方式
> POST

body参数说明

| 参数        | 是否必须      | 说明                                                                      |
| -----------|:-------:| ------:|
| fileID       | 是            | 文件编号|
| fileUrl    | 是    |文件地址|



###业务流程

1.根据所传fileID更新文件表的对应信息（cbUrl和状态）。标记为“申请下载中”。

2.定时任务，查询文件表中申请下载的文件，获取到对应的压缩包编号，根据编号查询CID，然后调用IPFS的API开始下载压缩包文件，并更新文件表中状态为“正在下载”，下载完成后更新状态为“已下载”。

3.定时任务，查询表中已下载的文件记录，使用密码开始解压文件，根据文件编号解压指定文件至下载目录。调用客户端提供的回调接口，回传 fileID和fileUrl。可以通过返回的链接下载该文件。

4.根据业务情况和硬件的存储空间，对已经长时间处于可提取状态的目录做删除，并将原有的任务记录标记为“已过期”。

###后台管理功能
* 首页
    * 上传测试文件
* 文件管理
    * 文件列表展示
* IPFS管理
    * 压缩包列表展示

###数据库设计
文件信息表 file_upload_info

| 字段名        | 是否必须      | 说明                                                                      |
| -----------|:-------:| ------:|
| file_id        | 是    | 文件编号|
| file_type       | 是    | 文件类型|
| folder_id    | 是    | 所在文件夹编号|
| zip_id    | 是    | 压缩包编号|
| cb_url    | 是    | 回调地址|
| status      | 是（默认 0）    | 状态 文件状态：0：未压缩，1：已压缩，2：请求下载，3：正在下载，4：下载失败，5：完成回调 |
| update_time | 否    | 更新时间|
| create_time | 否    | 创建时间|

压缩包信息表 zip_ipfs_info

| 字段名        | 是否必须      | 说明                                                                      |
| -----------|:-------:| ------:|
| zip_id        | 是    | 压缩包编号|
| cid    | 是    | ipfs返回的cid|
| key    | 是    | 加解密随机码|
| iv    | 是   | 加解密随机数|
| size    |是   | 压缩包大小|
| status      | 是（默认 0）    | 文件状态：0：未下单，1：下单成功，2：下单失败，3：未过期，4：已过期|
| expired_on| 否    | 过期块高|
| calculated_at| 否    | 当前块高|
| update_time | 否    | 更新时间|
| create_time | 否    | 创建时间|

### 代码测试
1、首先本地启动IPFS程序，使用 jsipfs daemon 或 IPFS客户端。
2、根据本地环境修改配置文件，主要是MySQL和Redis的配置信息，详情参考 [egg](https://github.com/eggjs/egg)
```bash
$ npm i ipfs-http-client
$ npm i
$ npm run dev
$ 
$ open http://localhost:7001/ （后台系统页面）
```
3、后台系统说明
* http://localhost:7001/ 为首页，可上传测试文件。
* http://localhost:7001/file 为文件列表，可查看已上传的文件。
* http://localhost:7001/zip 为压缩包列表，可查看cid和过期时间。
